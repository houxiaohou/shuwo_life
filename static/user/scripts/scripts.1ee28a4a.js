"use strict";angular.module("shuwoApp",["ngAnimate","ngCookies","ngTouch","ui.router","mgcrea.ngStrap.collapse","LocalStorageModule","infinite-scroll","services.config"]).config(["$urlRouterProvider","$stateProvider","$httpProvider","localStorageServiceProvider","configuration",function(a,b,c,d,e){d.setPrefix("sw");var f=["$rootScope","$q","$injector",function(a,b){function c(a){return a}function d(a){var c=a.status;return 401==c?void alert("用户身份不正确，请重新进入"):b.reject(a)}return function(a){return a.then(c,d)}}];c.responseInterceptors.push(f),c.defaults.headers.post["Content-Type"]="application/x-www-form-urlencoded;charset=utf-8",c.defaults.transformRequest=function(a){return void 0===a?a:$.param(a)},a.otherwise("/");var g=e.templateBase;b.state("shuwo",{"abstract":!0,url:"",templateUrl:g+"views/base.html"}).state("shuwo.default",{url:"/",templateUrl:g+"views/default.html",controller:"DefaultCtrl"}).state("shuwo.shop",{"abstract":!0,url:"/shop",template:"<ui-view />"}).state("shuwo.shop.detail",{url:"/{shopId:[0-9]{1,10}}",templateUrl:g+"views/shop.detail.html",controller:"ShopCtrl"}).state("shuwo.order",{"abstract":!0,url:"/order",template:"<ui-view />"}).state("shuwo.order.list",{url:"",templateUrl:g+"views/order.list.html",controller:"OrderCtrl"}).state("shuwo.order.detail",{url:"/{orderId:[0-9]{1,10}}",templateUrl:g+"views/order.detail.html",controller:"OrderDetailCtrl"}).state("shuwo.order.success",{url:"/{orderId:[0-9]{1,20}}/success",templateUrl:g+"views/order.success.html",controller:"OrderSuccessCtrl"}).state("shuwo.location",{url:"/location",templateUrl:g+"views/location.html",controller:"LocationCtrl"}).state("shuwo.cart",{url:"/cart",templateUrl:g+"views/cart.html",controller:"CartCtrl"}).state("shuwo.checkout",{url:"/checkout",templateUrl:g+"views/checkout.html",controller:"CheckoutCtrl"}).state("shuwo.address",{"abstract":!0,url:"/address",template:"<ui-view />"}).state("shuwo.address.list",{url:"",templateUrl:g+"views/address.list.html",controller:"AddressCtrl"}).state("shuwo.address.add",{url:"/add",templateUrl:g+"views/address.add.html",controller:"AddressAddCtrl"}).state("shuwo.address.edit",{url:"/edit/{id:[0-9]{1,10}}",templateUrl:g+"views/address.edit.html",controller:"AddressEditCtrl"})}]).run(["$http","$cookies",function(a,b){var c=b.utoken;a.defaults.headers.common.Authorization=c,FastClick.attach(document.body)}]),angular.module("shuwoApp").controller("BaseCtrl",["$scope","location","geolocation","page",function(a,b,c,d){a.page=d,b.getStoredLocation()||c.getLocation().then(function(a){var c=a.coords.latitude,d=a.coords.longitude,e=new BMap.Point(d,c);(new BMap.Geocoder).getLocation(e,function(a){var e=a.addressComponents,f={name:e.district+e.street+e.streetNumber,lat:c,lng:d};b.setLocation(f)})})}]),angular.module("shuwoApp").controller("DefaultCtrl",["$scope","page","location","shop","bridge",function(a,b,c,d,e){b.showFooter(),b.setFooterNav("shop"),a.locationLoading=!0,a.$watch(function(){return c.getStoredLocation()},function(b){void 0!==b&&(a.locationLoading=!1,a.location=c.getStoredLocation())}),a.shopLoading=!0,a.location=c.getStoredLocation(),a.$watch("location",function(b){void 0!==b&&d.listShopsNearBy(0,5).success(function(b){a.shops=b,a.shopLoading=!1})}),a.toShop=function(a){e.setObject("shop",a)}}]),angular.module("shuwoApp").service("page",function(){var a=!0,b="shop";return{hideFooter:function(){a=!1},showFooter:function(){a=!0},hasFooter:function(){return a},setFooterNav:function(a){b=a},getFooterNav:function(){return b}}}),angular.module("shuwoApp").service("location",["$rootScope","storage",function a(b,c){var a=void 0;return{getStoredLocation:function(){return a&&a.name&&a.lat&&a.lng||c.getItem("location")&&(a=angular.fromJson(c.getItem("location"))),a},setLocation:function(d){"$apply"!=b.$root.$$phase&&"$digest"!=b.$root.$$phase?b.$apply(function(){a=d}):a=d,c.setItem("location",angular.toJson(d))}}}]),angular.module("shuwoApp").service("storage",["$cookies","localStorageService",function(a,b){var c=b.isSupported;return{setItem:function(d,e){return c?void b.set(d,e):void(a[d]=e)},getItem:function(d){return c?b.get(d):a[d]},removeItem:function(a){b.remove(a)}}}]),angular.module("shuwoApp").controller("LocationCtrl",["$scope","page","location","$state","geolocation",function(a,b,c,d,e){function f(a){c.setLocation(a),d.go("shuwo.default")}b.hideFooter(),a.loading=!1,a.currentLoading=!0,a.noResults=!1,a.keyword="",a.results=[],a.current={},e.getLocation().then(function(b){var c=b.coords.latitude,d=b.coords.longitude,e=new BMap.Point(d,c);(new BMap.Geocoder).getLocation(e,function(b){var e=b.addressComponents;a.current={name:e.district+e.street+e.streetNumber,lat:c,lng:d},a.currentLoading=!1,a.$apply()})}),a.currentLocation=function(){a.current.name&&f(a.current)},a.doSearch=function(){a.results=[],a.loading=!0,a.noResults=!1;var b={pageCapacity:20,onSearchComplete:function(b){if(a.loading=!1,c.getStatus()==BMAP_STATUS_SUCCESS)for(var d=0;d<b.getCurrentNumPois();d++)a.results.push(b.getPoi(d));else a.noResults=!0;a.$apply()}},c=new BMap.LocalSearch("上海市",b);c.search(a.keyword)},a.changeLocation=function(a){var b={name:a.title,lat:a.point.lat,lng:a.point.lng};f(b)}}]),angular.module("shuwoApp").controller("ShopCtrl",["$scope","page","$stateParams","cart","shop","product","bridge",function(a,b,c,d,e,f,g){b.hideFooter(),b.setFooterNav("shop");var h=c.shopId,i=g.getObject();"shop"==i.type&&i.value.shopid==h?a.shop=i.value:e.getShopById(h).success(function(b){a.shop=b}),a.loading=!0,0==d.cartObj().items.length&&d.cartHistory(),a.cart=d,f.listProductsByShop(h).success(function(b){a.products=b,a.loading=!1}),a.productCart=function(a){d.isInCart(a)?d.removeItem(a):d.addItem(a)}}]),angular.module("shuwoApp").service("cart",["storage","cache",function(a,b){function c(){a.setItem(d,angular.toJson(e))}var d="cart",e={shopId:-1,items:[]};return{truncate:function(){e={shopId:-1,items:[]},a.removeItem(d)},items:function(){return e.items},cartObj:function(){return e},addItem:function(f){var g=f.shopid,h=f.productid;-1!=e.shopId&&e.shopId!=g&&(e={shopId:-1,items:[]},a.removeItem(d)),e.shopId=g;var i=_.where(e.items,{productId:h});0===i.length&&(e.shopId=g,e.items.push({productId:h,num:1})),b.putProduct(f),c()},removeItem:function(a){var b=a.productid,d=_.where(e.items,{productId:b});if(d.length>0){var f=e.items.indexOf(d[0]);f>-1&&e.items.splice(f,1)}c()},isInCart:function(a){var b=_.where(e.items,{productId:a.productid});return 0!==b.length},cartHistory:function(){var b=a.getItem(d);return b&&(e=angular.fromJson(b)),e},syncCart:function(){c()}}}]),angular.module("shuwoApp").service("shop",["constants","location","$http",function(a,b,c){return{listShopsNearBy:function(d,e){d=void 0===d?0:d,e=void 0===e?5:e;var f=b.getStoredLocation();return c.get(a.API.shops,{params:{lat:f.lat,lng:f.lng,start:d,count:e}})},getShopById:function(d){var e=b.getStoredLocation();return c.get(a.API.shop+"/"+d,{params:{lat:e.lat,lng:e.lng}})}}}]),angular.module("shuwoApp").service("product",["constants","$http",function(a,b){return{listProductsByShop:function(c){return b.get(a.API.shop+"/"+c+"/products")},getProductById:function(c){return b.get(a.API.product+"/"+c)},calculateProductPrice:function(a,b){return"1"===a.attribute?b*a.unitweight/500*a.discount:"2"==a.attribute?250*b*a.discount/500:"3"==a.attribute?b*a.discount:void 0}}}]),angular.module("shuwoApp").service("constants",["configuration",function(a){var b=a.urlPrefix;return{API:{shops:b+"/shops",shop:b+"/shop",product:b+"/product",address:b+"/address",order:b+"/order",userOrder:b+"/user/orders"}}}]),angular.module("shuwoApp").filter("distance",function(){return function(a){if(isNaN(Number(a)))return"未知";if(500>a)return"<500m";if(1e3>a)return a+"m";if(2e3>=a){var b=new Number(a/1e3).toFixed(2);return 1==b?"1km":b+"km"}return a>2e3?">2km":"distance filter: "+a}}),angular.module("shuwoApp").service("bridge",function(){var a,b={type:void 0,value:void 0};return{setObject:function(a,c){b.type=a,b.value=c},getObject:function(){return b},setAddress:function(b){a=b},getAddress:function(){return a}}}),angular.module("shuwoApp").filter("unitnum",function(){return function(a){return Math.ceil(parseFloat(1e3/a))}}),angular.module("shuwoApp").controller("CartCtrl",["$scope","$state","page","cart","cache","product","shop","storage","configuration",function(a,b,c,d,e,f,g,h,i){function j(){for(var b in m){var c=m[b],d=c.productId,g=e.getProduct(c.productId);g?a.products.push(g):f.getProductById(d).success(function(b){a.products.push(b),e.putProduct(b)})}}function k(){var b=0;for(var c in a.items){var d=a.items[c],e=d.product;b+=f.calculateProductPrice(e,d.num)}return b}c.hideFooter(),a.shopLoading=!0,a.productLoading=!0,a.noneImage=i.imagePath+"wan.png";var l=d.cartObj();0==l.items.length&&(l=d.cartHistory());var m=l.items,n=l.shopId;a.shop={},a.items=angular.copy(m),a.products=[],g.getShopById(n).success(function(b){a.shop=b,a.shopLoading=!1}),a.$watch("products",function(b){if(b.length==a.items.length){for(var c in a.items){var d=a.items[c],e=_.where(a.products,{productid:d.productId})[0];d.product=e}a.totalPrice=k,a.productLoading=!1}},!0),a.back=function(){console.log("backing..."),a.shop.shopid?b.go("shuwo.shop.detail",{shopId:a.shop.shopid}):b.go("shuwo.default")},j(),a.plus=function(a){a.num=a.num+1},a.minus=function(a){a.num>1&&(a.num=a.num-1)},a.removeFromCart=function(b,c){d.removeItem(b),a.items.slice(c,1)},a.submit=function(){var c=[];for(var d in a.items){var e=a.items[d],g=e.product,i=f.calculateProductPrice(g,e.num);console.log(i);var j="";"1"==g.attribute?j=e.num*g.unitweight:"2"==g.attribute&&(j=250*e.num),c.push({productId:g.productid,name:g.productname,num:e.num,price:i,weight:j,unit:g.unit,attribute:g.attribute})}var k={shopid:a.shop.shopid,items:c};h.setItem("order",angular.toJson(k)),b.go("shuwo.checkout")},a.$watch("items",function(b){void 0!=b&&(d.cartObj().items=a.items,d.syncCart())},!0)}]),angular.module("shuwoApp").factory("geolocation",["$q","$rootScope","$window",function(a,b,c){return{getLocation:function(d){var e=a.defer();return c.navigator&&c.navigator.geolocation?c.navigator.geolocation.getCurrentPosition(function(a){b.$apply(function(){e.resolve(a)})},function(a){switch(a.code){case 1:b.$broadcast("error","You have rejected access to your location"),b.$apply(function(){e.reject("You have rejected access to your location")});break;case 2:b.$broadcast("error","Unable to determine your location"),b.$apply(function(){e.reject("Unable to determine your location")});break;case 3:b.$broadcast("error","Service timeout has been reached"),b.$apply(function(){e.reject("Service timeout has been reached")})}},d):(b.$broadcast("error","Browser does not support location services"),b.$apply(function(){e.reject("Browser does not support location services")})),e.promise}}}]),angular.module("shuwoApp").service("cache",["$cacheFactory",function(){var a={};return{putProduct:function(b){var c="product-"+b.productid;a[c]=b},removeProduct:function(b){var c="product-"+b;delete a[c]},getProduct:function(b){var c="product-"+b;return a[c]}}}]),angular.module("shuwoApp").directive("imodal",function(){return{restrict:"EAC",scope:{imodal:"="},link:function(a){var b=void 0;a.$watch("imodal",function(a){void 0!==a&&(b=a)})}}}),angular.module("shuwoApp").controller("CheckoutCtrl",["$scope","$state","address","bridge","storage","page","order","cart",function(a,b,c,d,e,f,g,h){f.hideFooter(),a.notes="",a.addressLoading=!0,a.submitting=!1,d.getAddress()?(a.address=d.getAddress(),a.addressLoading=!1):c.getDefaultAddress().success(function(c){a.address=c,a.addressLoading=!1,0==c.length&&b.go("shuwo.address.add")}).error(function(){b.go("shuwo.address.add"),a.addressLoading=!1});var i=e.getItem("order");if(i){var j=angular.fromJson(i);a.shopid=j.shopid,a.items=j.items,a.totalPrice=function(){var b=0;for(var c in a.items)b+=a.items[c].price;return b}}else b.go("shuwo.cart");a.times=[{label:"立即送出",value:0},{label:"8:00-10:00",value:1},{label:"10:00-12:00",value:2},{label:"12:00-14:00",value:3},{label:"14:00-16:00",value:4},{label:"16:00-18:00",value:5},{label:"18:00-20:00",value:6}],a.selectedTime=a.times[0],a.submit=function(){a.submitting=!0;var c=[];for(var d in a.items){var f=a.items[d];c.push({productid:f.productId,quantity:f.num})}var i={said:a.address.said,shopid:a.shopid,orderdetail:JSON.stringify(c),dltime:a.selectedTime.label,notes:a.notes};g.createOrder(i).success(function(a){b.go("shuwo.order.success",{orderId:a.orderid}),e.removeItem("order"),e.removeItem("cart"),h.truncate()})}}]),angular.module("shuwoApp").controller("AddressCtrl",["$scope","$state","$timeout","address","bridge",function(a,b,c,d,e){a.loading=!0,a.addressList=[],d.listUserAddress().success(function(b){a.addressList=b,a.loading=!1}).error(function(){a.loading=!1}),a.removeAddress=function(b){confirm("确认删除地址吗？")&&d.deleteAddress(b.said).success(function(){var c=a.addressList.indexOf(b);a.addressList.splice(c,1)})},a.setDefault=function(f){for(var g in a.addressList){var h=a.addressList[g];h.isdefault="0"}f.isdefault="1",d.setAddressDefault(f.said),e.setAddress(f),c(function(){b.go("shuwo.checkout")},100)}}]),angular.module("shuwoApp").controller("AddressAddCtrl",["$rootScope","$scope","$state","address",function(a,b,c,d){var e="shuwo.address.list";b.address={userid:1,province:"上海",city:"上海市区",district:"上海"},a.$on("$stateChangeSuccess",function(a,b,c,d){e=d.name}),b.pattern=function(){return{test:function(a){return/^1(3|4|5|7|8)\d{9}$/.test(a)}}}(),b.saveAddress=function(){d.addAddress(b.address).success(function(){c.go(e)})}}]),angular.module("shuwoApp").controller("AddressEditCtrl",["$scope","$state","$stateParams","address",function(a,b,c,d){var e=c.id;a.loading=!0,d.getAddressById(e).success(function(b){a.address=b,a.loading=!1}).error(function(){a.address={},a.loading=!1}),a.pattern=function(){return{test:function(a){return/^1(3|4|5|7|8)\d{9}$/.test(a)}}}(),a.saveAddress=function(){d.updateAddress(a.address),b.go("shuwo.address.list")}}]),angular.module("shuwoApp").filter("price",function(){return function(a){return Number(a).toFixed(2)}}),angular.module("shuwoApp").filter("weight",function(){return function(a){return 500>a?a+"g":Number(a/1e3).toFixed(2)+"kg"}}),angular.module("shuwoApp").service("address",["$http","constants",function(a,b){return{listUserAddress:function(){return a.get(b.API.address)},getAddressById:function(c){return a.get(b.API.address+"/"+c)},updateAddress:function(c){return a.post(b.API.address+"/"+c.said,c)},addAddress:function(c){return a.post(b.API.address,c)},deleteAddress:function(c){return a["delete"](b.API.address+"/"+c)},setAddressDefault:function(c){return a.post(b.API.address+"/"+c+"/default")},getDefaultAddress:function(){return a.get(b.API.address+"/default")}}}]),angular.module("shuwoApp").controller("OrderCtrl",["$scope","page","order","configuration",function(a,b,c,d){b.setFooterNav("order"),a.orders=[],a.start=0,a.end=!1,a.noneImage=d.imagePath+"wan.png";var e=10;a.loadMore=function(){a.end||(a.loading=!0,c.listUserOrders(a.start,e).success(function(b){(0==b.length||b.length<e)&&(a.end=!0),a.loading=!1,a.orders.push.apply(a.orders,b),a.start+=e}).error(function(){a.loading=!1,a.start+=e,a.end=!0}))},a.isNaN=isNaN}]),angular.module("shuwoApp").controller("OrderDetailCtrl",["$scope","$stateParams","order","page",function(a,b,c,d){d.setFooterNav("order");var e=b.orderId;a.loading=!0,c.getOrderById(e).success(function(b){a.order=b,a.loading=!1}).error(function(){a.loading=!1})}]),angular.module("shuwoApp").controller("OrderSuccessCtrl",["$scope","$stateParams","order","page",function(a,b,c,d){d.setFooterNav("order");var e=b.orderId;a.loading=!0,c.getOrderById(e).success(function(b){a.order=b,a.loading=!1}).error(function(){a.loading=!1})}]),angular.module("shuwoApp").service("order",["$http","constants",function(a,b){return{listUserOrders:function(c,d){return a.get(b.API.userOrder,{params:{start:c,count:d,status:-1}})},getOrderById:function(c){return a.get(b.API.order+"/"+c)},createOrder:function(c){return a.post(b.API.order,c)}}}]),angular.module("services.config",[]).constant("configuration",{urlPrefix:"/Api",templateBase:"/static/user/",imagePath:"/static/user/images/"}),angular.module("shuwoApp").filter("orderStatus",function(){return function(a){return 0==a?"待确认":1==a?"已确认":2==a?"无效":void 0}});